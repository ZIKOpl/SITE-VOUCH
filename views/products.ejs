<section class="page">
  <div class="container">
    <div class="header-row">
      <h1>üõçÔ∏è Produits disponibles</h1>
      <% if (user?.isAdmin) { %>
        <button class="btn btn-primary" onclick="openModal()">+ Ajouter un produit</button>
      <% } %>
    </div>

    <div id="products" class="grid">
      <% if (!products.length) { %>
        <div class="card"><p class="muted">Aucun produit n‚Äôa encore √©t√© ajout√©.</p></div>
      <% } else { %>
        <% products.forEach(p => { %>
          <div class="card product-card">
            <div class="product-image">
              <img src="<%= p.image || `/assets/img/default.png` %>" alt="<%= p.name %>">
            </div>

            <div class="product-body">
              <h2 class="product-name"><%= p.name %></h2>
              <p class="muted product-desc"><%= p.description || "Aucune description fournie." %></p>

              <% if (p.price && p.price > 0) { %>
                <div class="price-tag"><%= p.price.toFixed(2) %> ‚Ç¨</div>
              <% } else { %>
                <div class="price-tag muted">Prix sur demande</div>
              <% } %>
            </div>

            <% if (user?.isAdmin) { %>
              <div class="product-actions">
                <button type="button" class="btn btn-outline small btn-delete" data-id="<%= p.id %>">Supprimer</button>
              </div>
            <% } %>
          </div>
        <% }) %>
      <% } %>
    </div>
  </div>
</section>

<!-- Modal d‚Äôajout de produit -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">√ó</button>
    <h3>Ajouter un produit</h3>

    <form id="productForm" onsubmit="return submitProduct(event)">
      <div class="form-row">
        <input type="text" name="name" placeholder="Nom du produit" class="input" required>
        <input type="number" step="0.01" name="price" placeholder="Prix (optionnel)" class="input">
      </div>
      <div class="form-row full">
        <textarea name="description" placeholder="Description du produit" rows="3" class="input"></textarea>
      </div>
      <div class="form-row full">
        <input type="text" name="image" placeholder="URL de l‚Äôimage (optionnel)" class="input">
      </div>

      <div style="margin-top:14px;text-align:right;">
        <button type="button" class="btn btn-ghost" onclick="closeModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">Ajouter</button>
      </div>
    </form>
  </div>
</div>

<script>
function openModal() {
  document.getElementById("modal").classList.add("show");
}
function closeModal() {
  document.getElementById("modal").classList.remove("show");
  document.getElementById("productForm").reset();
}

// ‚úÖ Ajouter un produit
async function submitProduct(e) {
  e.preventDefault();
  const form = e.target;
  const data = Object.fromEntries(new FormData(form));
  data.price = data.price ? parseFloat(data.price) : null;

  const res = await fetch("/api/product", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });

  const json = await res.json();
  if (json.ok) {
    showToast("‚úÖ Produit ajout√© avec succ√®s !", "success");
    setTimeout(() => location.reload(), 1000);
  } else {
    showToast("‚ùå Erreur : " + json.message, "error");
  }
}

// ‚úÖ Supprimer un produit
document.addEventListener("click", async (e) => {
  const btn = e.target.closest(".btn-delete");
  if (!btn) return;
  const id = btn.dataset.id;
  if (!id) return;

  const confirmed = await showConfirm("Supprimer ce produit ?");
  if (!confirmed) return;

  try {
    const res = await fetch(`/api/product/${id}`, { method: "DELETE" });
    const json = await res.json();

    if (json.ok) {
      showToast("‚úÖ Produit supprim√© avec succ√®s !", "success");
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast("‚ùå Erreur suppression produit", "error");
    }
  } catch (err) {
    showToast("‚ùå " + err.message, "error");
  }
});
</script>
