<section class="page">
  <div class="container">
    <div class="header-row">
      <h1>Produits disponibles</h1>
      <% if (user?.isAdmin) { %>
        <button class="btn btn-primary" onclick="openModal()">+ Ajouter un produit</button>
      <% } %>
    </div>

    <div class="grid" id="products">
      <% if (!products.length) { %>
        <div class="card"><p class="muted">Aucun produit disponible.</p></div>
      <% } else { %>
        <% products.forEach(p => { %>
          <div class="card product-card">
            <div class="product-image">
              <img src="<%= p.image || '/assets/img/default.png' %>" alt="<%= p.name %>">
            </div>
            <div class="product-body">
              <h2 class="product-name"><%= p.name %></h2>
              <p class="muted"><%= p.description || "Aucune description." %></p>

              <% if (p.price) { %>
                <div class="price-tag"><%= p.price.toFixed(2) %> €</div>
              <% } else { %>
                <div class="price-tag muted">Prix sur demande</div>
              <% } %>
            </div>

            <% if (user?.isAdmin) { %>
              <div class="product-actions">
                <button class="btn btn-outline small btn-delete" data-id="<%= p.id %>">Supprimer</button>
              </div>
            <% } %>
          </div>
        <% }) %>
      <% } %>
    </div>
  </div>
</section>

<!-- MODAL AJOUT PRODUIT -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">×</button>
    <h3>Ajouter un produit</h3>

    <form id="productForm" onsubmit="return submitProduct(event)" enctype="multipart/form-data">
      <div class="form-row">
        <input type="text" name="name" placeholder="Nom du produit" class="input" required>
        <input type="number" step="0.01" name="price" placeholder="Prix" class="input">
      </div>

      <div class="form-row full">
        <textarea name="description" placeholder="Description" class="input" rows="3"></textarea>
      </div>

      <div class="form-row full">
        <input type="file" name="image" accept="image/*" class="input">
      </div>

      <div style="text-align:right;">
        <button type="button" class="btn btn-ghost" onclick="closeModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">Ajouter</button>
      </div>
    </form>
  </div>
</div>

<script>
function openModal() {
  document.getElementById("modal").classList.add("show");
}
function closeModal() {
  document.getElementById("modal").classList.remove("show");
  document.getElementById("productForm").reset();
}

// --- AJOUT PRODUIT ---
async function submitProduct(e) {
  e.preventDefault();

  const form = document.getElementById("productForm");
  const data = new FormData(form);

  const res = await fetch("/api/product", {
    method: "POST",
    body: data
  });

  const json = await res.json();
  if (json.ok) {
    showToast("Produit ajouté !", "success");
    setTimeout(() => location.reload(), 800);
  } else {
    showToast("Erreur : " + json.message, "error");
  }
}

// --- SUPPRESSION PRODUIT ---
document.addEventListener("click", async e => {
  const btn = e.target.closest(".btn-delete");
  if (!btn) return;

  const conf = confirm("Supprimer ce produit ?");
  if (!conf) return;

  const res = await fetch(`/api/product/${btn.dataset.id}`, {
    method: "DELETE"
  });

  const json = await res.json();
  if (json.ok) {
    showToast("Produit supprimé.", "success");
    setTimeout(() => location.reload(), 800);
  } else {
    showToast("Erreur suppression.", "error");
  }
});
</script>
