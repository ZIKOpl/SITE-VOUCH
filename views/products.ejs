<section class="page">
  <div class="container">
    <div class="header-row">
      <h1>üõçÔ∏è Produits disponibles</h1>
      <% if (user?.isAdmin) { %>
        <button class="btn btn-primary" onclick="openModal()">+ Ajouter un produit</button>
      <% } %>
    </div>

    <div id="products" class="grid">
      <% if (!products.length) { %>
        <div class="card">
          <p class="muted">Aucun produit n‚Äôa encore √©t√© ajout√©.</p>
        </div>
      <% } else { %>
        <% products.forEach(p => { %>
          <div class="card product-card">
            <!-- Image du produit (g√©n√©r√©e si absente) -->
            <div class="product-image">
              <img src="<%= p.image || `https://api.dicebear.com/8.x/shapes/svg?seed=${encodeURIComponent(p.name)}` %>" alt="<%= p.name %>">
            </div>

            <!-- Nom et description -->
            <div class="product-body">
              <h2 class="product-name"><%= p.name %></h2>

              <% if (p.description) { %>
                <p class="muted"><%= p.description %></p>
              <% } else { %>
                <p class="muted">Aucune description fournie.</p>
              <% } %>

              <!-- Prix -->
              <% if (p.price && p.price > 0) { %>
                <div class="price-tag">
                  <span><%= p.price.toFixed(2) %> ‚Ç¨</span>
                </div>
              <% } else { %>
                <div class="price-tag muted">Prix sur demande</div>
              <% } %>
            </div>

            <!-- Bouton admin -->
            <% if (user?.isAdmin) { %>
              <div class="product-actions">
                <button class="btn btn-outline small" data-id="<%= p.id %>" onclick="deleteProduct(this.dataset.id)">üóë Supprimer</button>
              </div>
            <% } %>
          </div>
        <% }) %>
      <% } %>
    </div>
  </div>
</section>

<!-- Modal d‚Äôajout de produit -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">√ó</button>
    <h3>Ajouter un produit</h3>

    <form id="addForm" onsubmit="return submitProduct(event)">
      <div class="form-row">
        <input type="text" name="name" placeholder="Nom du produit" class="input" required>
        <input type="number" step="0.01" name="price" placeholder="Prix (optionnel)" class="input">
      </div>
      <div class="form-row full">
        <textarea name="description" placeholder="Description du produit" rows="3" class="input"></textarea>
      </div>
      <div class="form-row full">
        <input type="text" name="image" placeholder="URL de l‚Äôimage (optionnel)" class="input">
      </div>

      <div style="margin-top:14px;text-align:right;">
        <button type="button" class="btn btn-ghost" onclick="closeModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">Ajouter</button>
      </div>
    </form>
  </div>
</div>

<script>
function openModal() {
  document.getElementById("modal").classList.add("show");
}
function closeModal() {
  document.getElementById("modal").classList.remove("show");
}

async function submitProduct(e) {
  e.preventDefault();
  const form = e.target;
  const data = Object.fromEntries(new FormData(form));
  if (!data.name.trim()) return alert("Nom du produit requis !");
  data.price = data.price ? parseFloat(data.price) : null;

  const res = await fetch("/api/product", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
  const json = await res.json();
  if (json.ok) location.reload();
  else alert("Erreur : " + json.message);
}

async function deleteProduct(id) {
  if (!confirm("Supprimer ce produit ?")) return;
  const res = await fetch(`/api/product/${id}`, { method: "DELETE" });
  const json = await res.json();
  if (json.ok) location.reload();
  else alert("Erreur suppression produit");
}
</script>