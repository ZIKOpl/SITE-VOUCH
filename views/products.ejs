<section class="page">
  <div class="container">
    <div class="header-row">
      <h1>üõçÔ∏è Produits disponibles</h1>
      <% if (user?.isAdmin) { %>
        <button class="btn btn-primary" onclick="openModal()">+ Ajouter un produit</button>
      <% } %>
    </div>

    <div id="products" class="grid">
      <!-- ‚úÖ Stockage s√©curis√© des produits -->
      <script id="products-data" type="application/json">
        <%- JSON.stringify(products || []).replace(/</g, '\\u003c') %>
      </script>

      <script>
        window.PRODUCTS = JSON.parse(document.getElementById('products-data').textContent);
      </script>

      <% if (!products.length) { %>
        <div class="card"><p class="muted">Aucun produit n‚Äôa encore √©t√© ajout√©.</p></div>
      <% } else { %>
        <% products.forEach(p => { %>
          <div class="card product-card">
            <div class="product-image">
              <img src="<%= p.image || `/assets/img/default.png` %>" alt="<%= p.name %>">
            </div>

            <div class="product-body">
              <h2 class="product-name"><%= p.name %></h2>
              <p class="muted product-desc"><%= p.description || "Aucune description fournie." %></p>

              <% if (p.price && p.price > 0) { %>
                <div class="price-tag"><%= p.price.toFixed(2) %> ‚Ç¨</div>
              <% } else { %>
                <div class="price-tag muted">Prix sur demande</div>
              <% } %>
            </div>

            <% if (user?.isAdmin) { %>
              <div class="product-actions">
                <button class="btn btn-outline small" onclick="editProductById('<%= p.id %>')">üìù Modifier</button>
                <button class="btn btn-outline small" data-id="<%= p.id %>" onclick="deleteProduct(this.dataset.id)">üóë Supprimer</button>
              </div>
            <% } %>
          </div>
        <% }) %>
      <% } %>
    </div>
  </div>
</section>

<!-- Modal d‚Äôajout / modification -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">√ó</button>
    <h3 id="modalTitle">Ajouter un produit</h3>

    <form id="productForm" onsubmit="return submitProduct(event)">
      <input type="hidden" name="id">
      <div class="form-row">
        <input type="text" name="name" placeholder="Nom du produit" class="input" required>
        <input type="number" step="0.01" name="price" placeholder="Prix (optionnel)" class="input">
      </div>
      <div class="form-row full">
        <textarea name="description" placeholder="Description du produit" rows="3" class="input"></textarea>
      </div>
      <div class="form-row full">
        <input type="text" name="image" placeholder="URL de l‚Äôimage (optionnel)" class="input">
      </div>

      <div style="margin-top:14px;text-align:right;">
        <button type="button" class="btn btn-ghost" onclick="closeModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  </div>
</div>

<script>
/* --- Ouvrir / fermer la modale --- */
function openModal(edit = false) {
  document.getElementById("modal").classList.add("show");
  document.getElementById("modalTitle").textContent = edit ? "Modifier le produit" : "Ajouter un produit";
}
function closeModal() {
  document.getElementById("modal").classList.remove("show");
  document.getElementById("productForm").reset();
  document.querySelector('[name="id"]').value = '';
}

/* --- Fonction appel√©e quand on clique sur "Modifier" --- */
function editProductById(id) {
  const products = window.PRODUCTS || [];
  const p = products.find(prod => String(prod.id) === String(id));

  if (!p) {
    showToast("‚ùå Produit introuvable", "error");
    return;
  }

  openModal(true);
  const form = document.getElementById("productForm");
  form.id.value = p.id || '';
  form.name.value = p.name || '';
  form.price.value = p.price || '';
  form.description.value = p.description || '';
  form.image.value = p.image || '';
}

/* --- Gestion du formulaire d‚Äôajout / √©dition --- */
async function submitProduct(e) {
  e.preventDefault();
  const form = e.target;
  const data = Object.fromEntries(new FormData(form));
  data.price = data.price ? parseFloat(data.price) : null;

  const url = data.id ? `/api/product/${data.id}` : "/api/product";
  const method = data.id ? "PUT" : "POST";

  try {
    const res = await fetch(url, {
      method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    const json = await res.json();

    if (json.ok) {
      showToast("‚úÖ Produit enregistr√© avec succ√®s", "success");
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast("‚ùå " + (json.message || "Erreur lors de l'enregistrement"), "error");
    }
  } catch (err) {
    showToast("‚ùå Erreur de communication avec le serveur", "error");
  }
}

/* --- Suppression d‚Äôun produit --- */
async function deleteProduct(id) {
  const confirmed = await showConfirm("üóë Supprimer ce produit ?");
  if (!confirmed) return;

  try {
    const res = await fetch(`/api/product/${id}`, { method: "DELETE" });
    const json = await res.json();

    if (json.ok) {
      showToast("‚úÖ Produit supprim√© avec succ√®s", "success");
      setTimeout(() => location.reload(), 1000);
    } else {
      showToast("‚ùå Erreur suppression produit", "error");
    }
  } catch (err) {
    showToast("‚ùå Erreur r√©seau ou serveur", "error");
  }
}
</script>
