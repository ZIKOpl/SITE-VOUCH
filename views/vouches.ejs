<section>
  <h1 class="title">Tous les vouches</h1>

  <div class="searchbar">
    <input id="search" class="input" placeholder="Rechercher (vendeur, item, commentaire, auteur...)" autocomplete="off">
    <button id="clearSearch" class="btn btn-outline">Effacer</button>
    <% if (user) { %>
      <button id="openCreate" class="btn btn-primary">CrÃ©er un vouch</button>
    <% } %>
  </div>

  <% if (!vouches.length) { %>
    <div class="card"><p>Aucun vouch pour le moment.</p></div>
  <% } %>

  <div id="vouchGrid" class="grid">
    <% vouches.forEach(v => { %>
      <article
        class="card vouch-card"
        tabindex="0"
        data-id="<%- v.id %>"
      >
        <div class="card head">
          <div class="badge">Note : <strong><%= "â­".repeat(v.note) + "âœ©".repeat(5 - v.note) %></strong> (<%= v.note %>/5)</div>
          <div class="muted"><%= v.createdAtFmt %></div>
        </div>

        <div class="card-body">
          <p><span class="muted">Vendeur :</span> <strong><%= v.vendorLabel || (v.vendorId ? '@'+v.vendorId : 'Inconnu') %></strong></p>
          <p><span class="muted">Item :</span> <strong>x<%= v.qty %> <%= v.item %></strong> â€” <%= v.prix %> via <%= v.payment %></p>
          <p><span class="muted">Par :</span> <%= v.anonymous ? "Anonyme" : v.authorTag %></p>
          <p><span class="muted">Commentaire :</span> <%= (v.comment && v.comment.trim().length) ? v.comment : "â€”" %></p>
          <% if (v.source === "site") { %>
            <p class="muted">Origine : <strong>SITE</strong></p>
          <% } %>
        </div>

        <% if (user && user.isAdmin) { %>
          <div style="margin-top:10px;text-align:right">
            <button class="btn btn-outline btn-delete" data-id="<%- v.id %>">ðŸ—‘ Supprimer</button>
          </div>
        <% } %>
      </article>
    <% }) %>
  </div>
</section>

<!-- Modale de crÃ©ation -->
<script type="text/template" id="tpl-create-vouch">
  <h3>CrÃ©er un vouch</h3>
  <form id="createVouchForm">
    <div class="form-row">
      <div class="full">
        <label>Vendeur</label>
        <select name="vendeur" required>
          <% (vendors||[]).forEach(v => { %>
            <option value="<%- v.id || v.label %>"><%- v.label || ('@'+v.id) %></option>
          <% }) %>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div>
        <label>QuantitÃ©</label>
        <input class="input" name="quantite" type="number" min="1" value="1" required>
      </div>
      <div>
        <label>Item</label>
        <select name="item" required>
          <% (items||[]).forEach(it => { %>
            <option value="<%- it %>"><%- it %></option>
          <% }) %>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div>
        <label>Prix (ex: 2.5â‚¬)</label>
        <input class="input" name="prix" type="text" placeholder="2.5â‚¬" required>
      </div>
      <div>
        <label>Paiement</label>
        <select name="moyen_de_paiement" required>
          <% (payments||["PayPal","Crypto","LTC"]).forEach(p => { %>
            <option value="<%- p %>"><%- p %></option>
          <% }) %>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div>
        <label>Note /5</label>
        <select name="note" required>
          <% for (let i = 5; i >= 0; i--) { %>
            <option value="<%= i %>"><%= i %></option>
          <% } %>
        </select>
      </div>
      <div>
        <label>Anonyme ?</label>
        <select name="anonyme">
          <option value="false">Non</option><option value="true">Oui</option>
        </select>
      </div>
    </div>

    <div class="form-row full">
      <label>Commentaire (optionnel)</label>
      <textarea class="input" name="commentaire" rows="3" placeholder="Ton avis..."></textarea>
    </div>

    <div class="form-row full" style="text-align:right">
      <button type="button" class="btn btn-outline" id="cancelCreate">Annuler</button>
      <button type="submit" class="btn btn-primary">Envoyer le vouch</button>
    </div>
  </form>
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ðŸ—‘ Suppression dâ€™un vouch
  document.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.getAttribute('data-id');
      const confirmed = await showConfirm("ðŸ—‘ Supprimer ce vouch ?");
      if (!confirmed) return;

      try {
        const res = await fetch(`/api/vouch/${id}`, { method: "DELETE" });
        const json = await res.json();

        if (json.ok) {
          showToast("âœ… Vouch supprimÃ© avec succÃ¨s", "success");
          setTimeout(() => location.reload(), 1200);
        } else {
          showToast("âŒ Erreur : " + json.message, "error");
        }
      } catch (err) {
        showToast("âŒ Erreur de communication avec le serveur", "error");
      }
    });
  });

  // ðŸ” Recherche rapide
  const search = document.getElementById('search');
  const clear = document.getElementById('clearSearch');
  const cards = [...document.querySelectorAll('.vouch-card')];

  search?.addEventListener('input', () => {
    const val = search.value.toLowerCase();
    cards.forEach(c => {
      const text = c.textContent.toLowerCase();
      c.style.display = text.includes(val) ? '' : 'none';
    });
  });

  clear?.addEventListener('click', () => {
    search.value = '';
    cards.forEach(c => (c.style.display = ''));
  });
});
</script>
