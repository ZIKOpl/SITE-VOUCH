<section>
  <h1 class="title">Tous les vouches</h1>

  <div class="searchbar">
    <input id="search" class="input" placeholder="Rechercher (vendeur, item, commentaire, auteur...)" autocomplete="off">
    <button id="clearSearch" class="btn btn-outline">Effacer</button>
    <% if (user) { %>
      <button id="openCreate" class="btn btn-primary">Cr√©er un vouch</button>
    <% } %>
  </div>

  <% if (!vouches.length) { %>
    <div class="card"><p>Aucun vouch pour le moment.</p></div>
  <% } %>

  <div id="vouchGrid" class="grid">
    <% vouches.forEach(v => { %>
      <article
        class="card vouch-card"
        tabindex="0"
        data-id="<%- v.id %>"
      >
        <div class="card head">
          <div class="badge">Note : <strong><%= "‚≠ê".repeat(v.note) + "‚ú©".repeat(5 - v.note) %></strong> (<%= v.note %>/5)</div>
          <div class="muted"><%= v.createdAtFmt %></div>
        </div>

        <div class="card-body">
          <p><span class="muted">Vendeur :</span> <strong><%= v.vendorLabel || (v.vendorId ? '@'+v.vendorId : 'Inconnu') %></strong></p>
          <p><span class="muted">Item :</span> <strong>x<%= v.qty %> <%= v.item %></strong> ‚Äî <%= v.price %> via <%= v.payment %></p>
          <p><span class="muted">Par :</span> <%= v.anonymous ? "Anonyme" : v.authorTag %></p>
          <p><span class="muted">Commentaire :</span> <%= (v.comment && v.comment.trim().length) ? v.comment : "‚Äî" %></p>
          <% if (v.source === "site") { %>
            <p class="muted">Origine : <strong>SITE</strong></p>
          <% } %>
        </div>

        <% if (user && user.isAdmin) { %>
          <div style="margin-top:10px;text-align:right">
            <button class="btn btn-outline btn-delete" data-id="<%- v.id %>">üóë Supprimer</button>
          </div>
        <% } %>
      </article>
    <% }) %>
  </div>
</section>

<!-- Modale de cr√©ation active -->
<div id="modalCreateVouch" class="modal" style="display:none;">
  <div class="modal-content">
    <span id="closeCreate" class="close">&times;</span>
    <h3>Cr√©er un vouch</h3>
    <form id="createVouchForm">
      <div class="form-row">
        <label>Vendeur</label>
        <select name="vendeur" required>
          <% (vendors||[]).forEach(v => { %>
            <option value="<%- v.id || v.label %>"><%- v.label || ('@'+v.id) %></option>
          <% }) %>
        </select>
      </div>

      <div class="form-row">
        <label>Quantit√©</label>
        <input type="number" name="quantite" min="1" value="1" required>
      </div>

      <div class="form-row">
        <label>Item</label>
        <select name="item" required>
          <% (items||[]).forEach(it => { %>
            <option value="<%- it %>"><%- it %></option>
          <% }) %>
        </select>
      </div>

      <div class="form-row">
        <label>Prix</label>
        <input type="text" name="prix" placeholder="ex: 2.5‚Ç¨" required>
      </div>

      <div class="form-row">
        <label>Moyen de paiement</label>
        <select name="moyen_de_paiement" required>
          <% (payments||["PayPal","Crypto","LTC"]).forEach(p => { %>
            <option value="<%- p %>"><%- p %></option>
          <% }) %>
        </select>
      </div>

      <div class="form-row">
        <label>Note /5</label>
        <select name="note" required>
          <% for (let i = 5; i >= 0; i--) { %>
            <option value="<%= i %>"><%= i %></option>
          <% } %>
        </select>
      </div>

      <div class="form-row">
        <label>Anonyme ?</label>
        <select name="anonyme">
          <option value="false">Non</option>
          <option value="true">Oui</option>
        </select>
      </div>

      <div class="form-row">
        <label>Commentaire (optionnel)</label>
        <textarea name="commentaire" rows="3" placeholder="Ton avis..."></textarea>
      </div>

      <div class="form-row" style="text-align:right">
        <button type="button" id="cancelCreate" class="btn btn-outline">Annuler</button>
        <button type="submit" class="btn btn-primary">Envoyer</button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // üîπ Suppression d‚Äôun vouch
  document.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.getAttribute('data-id');
      const confirmed = await showConfirm("üóë Supprimer ce vouch ?");
      if (!confirmed) return;

      try {
        const res = await fetch(`/api/vouch/${id}`, { method: "DELETE" });
        const json = await res.json();
        if (json.ok) {
          showToast("‚úÖ Vouch supprim√© avec succ√®s", "success");
          setTimeout(() => location.reload(), 1200);
        } else {
          showToast("‚ùå Erreur : " + json.message, "error");
        }
      } catch (err) {
        showToast("‚ùå Erreur de communication avec le serveur", "error");
      }
    });
  });

  // üîπ Recherche rapide
  const search = document.getElementById('search');
  const clear = document.getElementById('clearSearch');
  const cards = [...document.querySelectorAll('.vouch-card')];

  search?.addEventListener('input', () => {
    const val = search.value.toLowerCase();
    cards.forEach(c => {
      const text = c.textContent.toLowerCase();
      c.style.display = text.includes(val) ? '' : 'none';
    });
  });

  clear?.addEventListener('click', () => {
    search.value = '';
    cards.forEach(c => (c.style.display = ''));
  });

  // üîπ Modale cr√©ation vouch
  const modal = document.getElementById("modalCreateVouch");
  const openBtn = document.getElementById("openCreate");
  const closeBtn = document.getElementById("closeCreate");
  const cancelBtn = document.getElementById("cancelCreate");
  const form = document.getElementById("createVouchForm");

  openBtn?.addEventListener("click", () => modal.style.display = "block");
  closeBtn?.addEventListener("click", () => modal.style.display = "none");
  cancelBtn?.addEventListener("click", () => modal.style.display = "none");
  window.addEventListener("click", e => { if(e.target == modal) modal.style.display = "none"; });

  // üîπ Soumission cr√©ation vouch
  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const body = {
      vendor: formData.get("vendeur"),
      note: Number(formData.get("note")),
      item: formData.get("item"),
      price: formData.get("prix"),
      payment: formData.get("moyen_de_paiement"),
      comment: formData.get("commentaire"),
      anonymous: formData.get("anonyme") === "true",
      qty: Number(formData.get("quantite")) || 1
    };
    if (!body.vendor || isNaN(body.note)) {
      alert("Veuillez remplir correctement le vendeur et la note.");
      return;
    }
    try {
      const res = await fetch("/api/vouch", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (data.ok) {
        alert(`Vouch cr√©√© avec succ√®s ! ID : ${data.id}`);
        form.reset();
        modal.style.display = "none";
        location.reload();
      } else {
        alert(`Erreur : ${data.message}`);
      }
    } catch (err) {
      console.error(err);
      alert("Erreur serveur, veuillez r√©essayer plus tard.");
    }
  });
});
</script>
