<section>
  <div class="section-title">
    <h1 class="title">Configuration</h1>
    <div>
      <span class="tag">Guild: <%= gid %></span>
      <span class="tag">Admins only</span>
    </div>
  </div>

  <!-- üßç Vendors -->
  <div class="card" style="margin-bottom:16px">
    <div class="card head"><div>Vendeurs</div></div>
    <div class="form-row">
      <input id="vendorId" class="input" placeholder="ID Discord (optionnel)">
      <input id="vendorLabel" class="input" placeholder="Nom / label (obligatoire)">
      <button id="addVendor" class="btn btn-primary">Ajouter</button>
    </div>
    <div class="table" style="margin-top:12px">
      <% (vendors || []).forEach(v => { %>
        <div class="row">
          <div><strong><%- v.label %></strong> <span class="muted"><%- v.id ? '('+v.id+')' : '' %></span></div>
          <div class="actions">
            <button class="btn btn-outline" data-remove-vendor="<%- v.id || v.label %>">Supprimer</button>
          </div>
        </div>
      <% }) %>
    </div>
  </div>

  <!-- üì¶ Items -->
  <div class="card" style="margin-bottom:16px">
    <div class="card head"><div>Items</div></div>
    <div class="form-row">
      <input id="itemName" class="input" placeholder="Nom de l'item">
      <button id="addItem" class="btn btn-primary">Ajouter</button>
    </div>
    <div class="table" style="margin-top:12px">
      <% (items || []).forEach(it => { %>
        <div class="row">
          <div><%- it %></div>
          <div class="actions">
            <button class="btn btn-outline" data-remove-item="<%- it %>">Supprimer</button>
          </div>
        </div>
      <% }) %>
    </div>
  </div>

  <!-- üí≥ Moyens de paiement -->
  <div class="card">
    <div class="card head"><div>Moyens de paiement</div></div>
    <div class="form-row">
      <input id="payName" class="input" placeholder="Nom du moyen de paiement">
      <button id="addPay" class="btn btn-primary">Ajouter</button>
    </div>
    <div class="table" style="margin-top:12px">
      <% (payments || []).forEach(p => { %>
        <div class="row">
          <div><%- p %></div>
          <div class="actions">
            <button class="btn btn-outline" data-remove-pay="<%- p %>">Supprimer</button>
          </div>
        </div>
      <% }) %>
    </div>
  </div>
</section>

<script>
/* --- Helper API --- */
async function postJSON(url, body) {
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  const json = await res.json();
  if (!res.ok) throw new Error(json.message || 'Erreur serveur');
  return json;
}

/* --- Ajout d‚Äôun vendeur --- */
document.getElementById('addVendor')?.addEventListener('click', async () => {
  const id = document.getElementById('vendorId').value.trim();
  const label = document.getElementById('vendorLabel').value.trim();
  if (!label) return showToast('‚ö†Ô∏è Le label est obligatoire.', 'error');

  try {
    await postJSON('/api/config/vendor/add', { id, label });
    showToast('‚úÖ Vendeur ajout√© avec succ√®s', 'success');
    setTimeout(() => location.reload(), 1000);
  } catch (e) {
    showToast('‚ùå ' + e.message, 'error');
  }
});

/* --- Suppression d‚Äôun vendeur --- */
document.querySelectorAll('[data-remove-vendor]')?.forEach(btn => {
  btn.addEventListener('click', async () => {
    const key = btn.getAttribute('data-remove-vendor');
    const confirmed = await showConfirm(`Supprimer le vendeur "${key}" ?`);
    if (!confirmed) return;

    try {
      await postJSON('/api/config/vendor/remove', { key });
      showToast('‚úÖ Vendeur supprim√© avec succ√®s', 'success');
      setTimeout(() => location.reload(), 1000);
    } catch (e) {
      showToast('‚ùå ' + e.message, 'error');
    }
  });
});

/* --- Ajout d‚Äôun item --- */
document.getElementById('addItem')?.addEventListener('click', async () => {
  const name = document.getElementById('itemName').value.trim();
  if (!name) return showToast("‚ö†Ô∏è Entrez un nom d'item.", 'error');

  try {
    await postJSON('/api/config/item/add', { name });
    showToast('‚úÖ Item ajout√© avec succ√®s', 'success');
    setTimeout(() => location.reload(), 1000);
  } catch (e) {
    showToast('‚ùå ' + e.message, 'error');
  }
});

/* --- Suppression d‚Äôun item --- */
document.querySelectorAll('[data-remove-item]')?.forEach(btn => {
  btn.addEventListener('click', async () => {
    const name = btn.getAttribute('data-remove-item');
    const confirmed = await showConfirm(`Supprimer l‚Äôitem "${name}" ?`);
    if (!confirmed) return;

    try {
      await postJSON('/api/config/item/remove', { name });
      showToast('‚úÖ Item supprim√© avec succ√®s', 'success');
      setTimeout(() => location.reload(), 1000);
    } catch (e) {
      showToast('‚ùå ' + e.message, 'error');
    }
  });
});

/* --- Ajout d‚Äôun moyen de paiement --- */
document.getElementById('addPay')?.addEventListener('click', async () => {
  const name = document.getElementById('payName').value.trim();
  if (!name) return showToast('‚ö†Ô∏è Entrez un moyen de paiement.', 'error');

  try {
    await postJSON('/api/config/payment/add', { name });
    showToast('‚úÖ Moyen de paiement ajout√©', 'success');
    setTimeout(() => location.reload(), 1000);
  } catch (e) {
    showToast('‚ùå ' + e.message, 'error');
  }
});

/* --- Suppression d‚Äôun moyen de paiement --- */
document.querySelectorAll('[data-remove-pay]')?.forEach(btn => {
  btn.addEventListener('click', async () => {
    const name = btn.getAttribute('data-remove-pay');
    const confirmed = await showConfirm(`Supprimer le moyen de paiement "${name}" ?`);
    if (!confirmed) return;

    try {
      await postJSON('/api/config/payment/remove', { name });
      showToast('‚úÖ Moyen de paiement supprim√©', 'success');
      setTimeout(() => location.reload(), 1000);
    } catch (e) {
      showToast('‚ùå ' + e.message, 'error');
    }
  });
});
</script>
