<section>
  <div class="section-title">
    <h1 class="title">Configuration</h1>
    <div>
      <span class="tag">Guild: <%= gid %></span>
      <span class="tag">Admins only</span>
    </div>
  </div>

  <!-- ğŸ§ Vendeurs -->
  <div class="card" style="margin-bottom:16px">
    <div class="card head"><div>Vendeurs</div></div>
    <div class="form-row">
      <input id="vendorId" class="input" placeholder="ID Discord (optionnel)">
      <input id="vendorLabel" class="input" placeholder="Nom / label (obligatoire)">
      <button id="addVendor" class="btn btn-primary">Ajouter</button>
    </div>

    <div class="table" style="margin-top:12px">
      <% (vendors || []).forEach(v => { %>
        <div class="row">
          <div>
            <strong><%- v.label %></strong>
            <span class="muted"><%- v.id ? '(' + v.id + ')' : '' %></span>
          </div>
          <div class="actions">
            <button class="btn btn-outline small" 
                    data-remove-vendor="<%- v.id || v.label %>" 
                    data-remove-vendor-label="<%- v.label %>">
              ğŸ—‘ Supprimer
            </button>
          </div>
        </div>
      <% }) %>
    </div>
  </div>

  <!-- ğŸ“¦ Items -->
  <div class="card" style="margin-bottom:16px">
    <div class="card head"><div>Items</div></div>
    <div class="form-row">
      <input id="itemName" class="input" placeholder="Nom de l'item">
      <button id="addItem" class="btn btn-primary">Ajouter</button>
    </div>

    <div class="table" style="margin-top:12px">
      <% (items || []).forEach(it => { %>
        <div class="row">
          <div><%- it %></div>
          <div class="actions">
            <button class="btn btn-outline small" data-remove-item="<%- it %>">ğŸ—‘ Supprimer</button>
          </div>
        </div>
      <% }) %>
    </div>
  </div>

  <!-- ğŸ’³ Moyens de paiement -->
  <div class="card">
    <div class="card head"><div>Moyens de paiement</div></div>
    <div class="form-row">
      <input id="payName" class="input" placeholder="Nom du moyen de paiement">
      <button id="addPay" class="btn btn-primary">Ajouter</button>
    </div>

    <div class="table" style="margin-top:12px">
      <% (payments || []).forEach(p => { %>
        <div class="row">
          <div><%- p %></div>
          <div class="actions">
            <button class="btn btn-outline small" data-remove-pay="<%- p %>">ğŸ—‘ Supprimer</button>
          </div>
        </div>
      <% }) %>
    </div>
  </div>
</section>

<script>
/* ---------------------------
   ğŸ§© Helper : POST JSON
---------------------------- */
async function postJSON(url, body) {
  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
  let json = {};
  try { json = await res.json(); } catch {}
  if (!res.ok) throw new Error(json.message || "Erreur serveur");
  return json;
}

/* ---------------------------
   â• Ajout vendeur
---------------------------- */
document.getElementById("addVendor")?.addEventListener("click", async () => {
  const id = document.getElementById("vendorId").value.trim();
  const label = document.getElementById("vendorLabel").value.trim();
  if (!label) return showToast("âš ï¸ Le label est obligatoire.", "error");

  try {
    await postJSON("/api/config/vendor/add", { id, label });
    showToast("âœ… Vendeur ajoutÃ© avec succÃ¨s", "success");
    setTimeout(() => location.reload(), 800);
  } catch (e) {
    showToast("âŒ " + e.message, "error");
  }
});

/* ---------------------------
   ğŸ—‘ Suppression vendeur
---------------------------- */
document.querySelectorAll("[data-remove-vendor]")?.forEach((btn) => {
  btn.addEventListener("click", async () => {
    const key = btn.getAttribute("data-remove-vendor");
    const label = btn.getAttribute("data-remove-vendor-label") || key;
    if (!key) return showToast("Erreur : clÃ© manquante.", "error");

    const confirmed = await showConfirm(`Supprimer le vendeur "${label}" ?`);
    if (!confirmed) return;

    try {
      await postJSON("/api/config/vendor/remove", { key });
      showToast("âœ… Vendeur supprimÃ© avec succÃ¨s", "success");
      setTimeout(() => location.reload(), 800);
    } catch (e) {
      showToast("âŒ " + e.message, "error");
    }
  });
});

/* ---------------------------
   â• Ajout item
---------------------------- */
document.getElementById("addItem")?.addEventListener("click", async () => {
  const name = document.getElementById("itemName").value.trim();
  if (!name) return showToast("âš ï¸ Entrez un nom d'item.", "error");

  try {
    await postJSON("/api/config/item/add", { name });
    showToast("âœ… Item ajoutÃ© avec succÃ¨s", "success");
    setTimeout(() => location.reload(), 800);
  } catch (e) {
    showToast("âŒ " + e.message, "error");
  }
});

/* ---------------------------
   ğŸ—‘ Suppression item
---------------------------- */
document.querySelectorAll("[data-remove-item]")?.forEach((btn) => {
  btn.addEventListener("click", async () => {
    const name = btn.getAttribute("data-remove-item");
    if (!name) return showToast("Erreur : nom manquant.", "error");

    const confirmed = await showConfirm(`Supprimer l'item "${name}" ?`);
    if (!confirmed) return;

    try {
      await postJSON("/api/config/item/remove", { name });
      showToast("âœ… Item supprimÃ©", "success");
      setTimeout(() => location.reload(), 800);
    } catch (e) {
      showToast("âŒ " + e.message, "error");
    }
  });
});

/* ---------------------------
   â• Ajout moyen de paiement
---------------------------- */
document.getElementById("addPay")?.addEventListener("click", async () => {
  const name = document.getElementById("payName").value.trim();
  if (!name) return showToast("âš ï¸ Entrez un moyen de paiement.", "error");

  try {
    await postJSON("/api/config/payment/add", { name });
    showToast("âœ… Moyen de paiement ajoutÃ©", "success");
    setTimeout(() => location.reload(), 800);
  } catch (e) {
    showToast("âŒ " + e.message, "error");
  }
});

/* ---------------------------
   ğŸ—‘ Suppression moyen de paiement
---------------------------- */
document.querySelectorAll("[data-remove-pay]")?.forEach((btn) => {
  btn.addEventListener("click", async () => {
    const name = btn.getAttribute("data-remove-pay");
    if (!name) return showToast("Erreur : nom manquant.", "error");

    const confirmed = await showConfirm(`Supprimer le moyen de paiement "${name}" ?`);
    if (!confirmed) return;

    try {
      await postJSON("/api/config/payment/remove", { name });
      showToast("âœ… Moyen de paiement supprimÃ©", "success");
      setTimeout(() => location.reload(), 800);
    } catch (e) {
      showToast("âŒ " + e.message, "error");
    }
  });
});
</script>
